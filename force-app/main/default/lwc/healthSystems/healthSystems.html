<template>
    <lightning-card>
        <!-- List view: show when NOT in detail mode -->
        <template if:false={showDetail}>

        <!-- Search Bar and Filter Button -->
        <div class="slds-m-around_small slds-grid slds-grid_align-end" style="gap: 0.5rem;">
            <div class="slds-col">
                <lightning-input type="search" value={searchKey} onchange={handleSearchChange} placeholder="Search"
                    class="search-bar">
                </lightning-input>
            </div>

            <!-- Download button (UI only) -->
            <div class="slds-col slds-align-bottom">
                    <button class="btn-download" title="Download CSV" aria-label="Download CSV" style="background-color: transparent; border: 1px solid #d8dde6; color: #16325c; border-radius: 4px; padding: 7px 10px; display:flex; align-items:center; gap:0.5rem;">
                    <lightning-icon icon-name="utility:download" size="x-small"></lightning-icon>
                </button>
            </div>

            <div class="slds-col slds-align-bottom">
                    <button class="btn-download" title="Grid Columns" aria-label="Grid Columns" style="background-color: transparent; border: 1px solid #d8dde6; color: #16325c; border-radius: 4px; padding: 7px 10px; display:flex; align-items:center; gap:0.5rem;">
                    <lightning-icon icon-name="utility:table" size="x-small"></lightning-icon>
                </button>
            </div>

            <!-- Grid Columns button (placed right after Download) -->

            <div class="slds-col slds-align-bottom">
                <button class="btn-filter-toggle"
                    style="background-color: black; color: white; border-radius: 4px; padding: 6px 14px;"
                    onclick={toggleFilters}>
                    <lightning-icon icon-name="utility:filterList" size="x-small"></lightning-icon>Filter
                </button>
            </div>
            <div class="slds-col slds-align-bottom">
                <button class="btn-filter-toggle"
                    style="background-color: #2e37a4 !important; color: white !important; border-radius: 4px; padding: 6px 14px; position: relative;" onclick={openAddModal}>
                    <span style="color: white; font-size: 1.5rem; position: absolute; top: 41%; left: 25%; transform: translate(-50%, -50%);"><b>+</b></span>
                    <span style="color: white; margin-left: 1.5rem;"><b>Add</b></span>
                </button>
            </div>
        </div>

        <!-- FILTER PANEL -->
        <template if:true={showFilters}>
            <div class="custom-filter-panel">
                <div class="filter-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h4>Filter</h4>
                        <a onclick={clearAllFilters}>Clear All</a>
                    </div>
                </div>
                <div class="filter-body">
                    <div class="filter-grid">

                        <!-- Status Filter -->
                        <div class="filter-item">
                            <div class="filter-item-header">
                                <label class="form-label">Status</label>
                                <!-- <a class="link-primary" onclick={resetStatusFilter}>Reset</a> -->
                            </div>
                            <div class="dropdown-container">
                                <button class="dropdown-btn" onclick={toggleStatusDropdown}>
                                    <span>{statusDisplayText}</span>
                                    <span class="chevron">▼</span>
                                </button>
                                <div class={statusDropdownClass}>
                                    <ul class="dropdown-options">
                                        <template for:each={statusOptions} for:item="opt">
                                            <li key={opt.value}>
                                                <label>
                                                    <input type="checkbox" value={opt.value} checked={opt.checked}
                                                        onchange={handleStatusCheckboxChange}>
                                                    {opt.label}
                                                </label>
                                            </li>
                                        </template>
                                    </ul>
                                    <div class="dropdown-actions">
                                        <!-- <button onclick={toggleStatusDropdown}>Cancel</button> -->
                                        <!-- <button class="btn-select" onclick={toggleStatusDropdown}>Select</button> -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- State Filter -->
                        <div class="filter-item">
                            <div class="filter-item-header">
                                <label class="form-label">State</label>
                                <!-- <a class="link-primary" onclick={resetStateFilter}>Reset</a> -->
                            </div>
                            <div class="dropdown-container">
                                <button class="dropdown-btn" onclick={toggleStateDropdown}>
                                    <span>{stateDisplayText}</span>
                                    <span class="chevron">▼</span>
                                </button>
                                <div class={stateDropdownClass}>
                                    <input type="text" class="dropdown-search" placeholder="Search State"
                                        oninput={handleStateSearchInput}>
                                    <ul class="dropdown-options">
                                        <template for:each={filteredStateOptions} for:item="opt">
                                            <li key={opt.value}>
                                                <label>
                                                    <input type="checkbox" value={opt.value} checked={opt.checked}
                                                        onchange={handleStateCheckboxChange}>
                                                    {opt.label}
                                                </label>
                                            </li>
                                        </template>
                                    </ul>
                                    <div class="dropdown-actions">
                                        <!-- <button onclick={toggleStateDropdown}>Cancel</button> -->
                                        <!-- <button class="btn-select" onclick={toggleStateDropdown}>Select</button> -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- City Filter -->
                        <div class="filter-item">
                            <div class="filter-item-header">
                                <label class="form-label">City</label>
                                <!-- <a class="link-primary" onclick={resetCityFilter}>Reset</a> -->
                            </div>
                            <div class="dropdown-container">
                                <button class="dropdown-btn" onclick={toggleCityDropdown}>
                                    <span>{cityDisplayText}</span>
                                    <span class="chevron">▼</span>
                                </button>
                                <div class={cityDropdownClass}>
                                    <input type="text" class="dropdown-search" placeholder="Search City"
                                        oninput={handleCitySearchInput}>
                                    <ul class="dropdown-options">
                                        <template for:each={filteredCityOptions} for:item="opt">
                                            <li key={opt.value}>
                                                <label>
                                                    <input type="checkbox" value={opt.value} checked={opt.checked}
                                                        onchange={handleCityCheckboxChange}>
                                                    {opt.label}
                                                </label>
                                            </li>
                                        </template>
                                    </ul>
                                    <div class="dropdown-actions">
                                        <!-- <button onclick={toggleCityDropdown}>Cancel</button> -->
                                        <!-- <button class="btn-select" onclick={toggleCityDropdown}>Select</button> -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- mNDA Filter -->
                        

                    </div>
                </div>

                <div class="filter-footer">
                    <div class="footer-actions">
                        <a class="btn-close" onclick={closeFilter}>Close</a>
                        <button class="btn-filter" onclick={applyFilter}>Filter</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Table Wrapper -->
        <div class="table-wrapper">
                <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                <thead>
                    <tr class="slds-line-height_reset">
                        <th scope="col">
                            <div class="slds-truncate">Actions</div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="hsId" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>HS ID</span>
                                <template if:true={isSortedBy.hsId}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="hsName" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>HS Name</span>
                                <template if:true={isSortedBy.hsName}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="status" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Status</span>
                                <template if:true={isSortedBy.status}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="projects" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Projects</span>
                                <template if:true={isSortedBy.projects}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="matches" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Matches</span>
                                <template if:true={isSortedBy.matches}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="matches" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Docs</span>
                                <template if:true={isSortedBy.matches}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="matches" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Legal</span>
                                <template if:true={isSortedBy.matches}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="messages" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Messages</span>
                                <template if:true={isSortedBy.messages}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="state" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>State</span>
                                <template if:true={isSortedBy.state}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="city" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>City</span>
                                <template if:true={isSortedBy.city}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="contact" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Contact</span>
                                <template if:true={isSortedBy.contact}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="email" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Email</span>
                                <template if:true={isSortedBy.email}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="phone" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Phone</span>
                                <template if:true={isSortedBy.phone}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                        <th scope="col" class="sortable-header" data-field="lastUpdated" onclick={handleSort}>
                            <div class="slds-truncate header-content">
                                <span>Last Updated</span>
                                <template if:true={isSortedBy.lastUpdated}>
                                    <span class={sortDirection}></span>
                                </template>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <template for:each={pagedData} for:item="row">
                        <tr key={row.id}>

                            <td>
                                <div class="slds-button-group" role="group">
                                    <lightning-button-icon icon-name="utility:edit" variant="bare"
                                        alternative-text="Edit" title="Edit" data-id={row.id} onclick={handleEdit}
                                        class="slds-m-right_x-small icon-edit">
                                    </lightning-button-icon>
                                        <lightning-button-icon
    icon-name="utility:delete"
    variant="bare"
    alternative-text="Delete"
    title="Delete"
    data-id={row.id}
    onclick={openDeleteModal}
    class="delete-btn"
    style="--sds-c-icon-color-foreground: #c23934;"
></lightning-button-icon>



                                </div>
                            </td>
                            <td>
                                <div class="slds-truncate clickable-cell" style="color: #0176d3; cursor: pointer;" onclick={handleHsIdClick} data-id={row.id}>{row.hsId}</div>
                            </td>
                            <td>
                                <div class="contact-cell" style="display:flex; align-items:center; gap:0.5rem;">
                                    <lightning-avatar alternative-text={row.hsName} initials={row.healthInitials} size="small"></lightning-avatar>
                                    <div class="contact-name slds-truncate">{row.hsName}</div>
                                </div>
                            </td>
                            <td>
                                <span class={row.statusClass}>
                                    {row.status}
                                </span>
                            </td>
                            <td>
                                <div class="slds-truncate center-link-cell" onclick={handleProjectCellClick} data-id={row.id}>{row.projects}</div>
                            </td>
                            <td>
                                <div class="slds-truncate center-link-cell" onclick={handleMatchCellClick} data-id={row.id}>{row.matches}</div>
                            </td>
                            <td>
                                <div class="slds-truncate center-link-cell" onclick={handleDocsCellClick} data-id={row.id}>{row.docs}</div>
                            </td>
                            <td>
                                <div class="slds-truncate center-link-cell" onclick={handleLegalCellClick} data-id={row.id}>{row.legal}</div>
                            </td>
                            <td>
                                <div class="slds-truncate center-link-cell" onclick={handleMessageCellClick} data-id={row.id}>{row.messages}</div>
                            </td>
                            <td>
                                <div class="slds-truncate">{row.state}</div>
                            </td>
                            <td>
                                <div class="slds-truncate">{row.city}</div>
                            </td>
                            <td>
                                <div class="contact-cell" style="display:flex; align-items:center; gap:0.5rem;">
                                    <!-- Use lightning-avatar which will show initials fallback if external image is blocked by CSP -->
                                    <lightning-avatar alternative-text={row.contact} initials={row.contactInitials} size="small"></lightning-avatar>
                                    <div class="contact-name slds-truncate">{row.contact}</div>
                                </div>
                            </td>
                            <td>
                                <div class="slds-truncate">{row.email}</div>
                            </td>
                            <td>
                                <div class="slds-truncate">{row.phone}</div>
                            </td>
                            <td>
                                <div class="slds-truncate">{row.lastUpdated}</div>
                            </td>

                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Reusable paginator component -->
        <c-paginator
            total-size={totalSize}
            page-size={pageSize}
            page-index={pageIndex}
            page-size-options={pageSizeOptions}
            onpagechange={handlePage}
        ></c-paginator>
        </template>

        <!-- Delete Confirmation Modal -->
        <template if:true={showDeleteModal}>
            <section role="dialog" aria-modal="true" class="hs-modal-backdrop">
                <div class="hs-modal">
                    <div class="hs-modal__header">
                        <div class="hs-modal__title">Delete Health System</div>
                        <button class="hs-modal__close" title="Close" onclick={closeDeleteModal} aria-label="Close">✕</button>
                    </div>
                    <div class="hs-modal__body">
                        <div style="padding: 8px 4px;">
                            <p>Do you want to delete <strong>{deleteRecordName}</strong>?</p>
                        </div>
                    </div>
                    <div class="hs-modal__footer">
                        <button class="hs-btn-outline" onclick={closeDeleteModal}>Cancel</button>
                        <button class="hs-btn-primary" onclick={confirmDelete}>Delete</button>
                    </div>
                </div>
            </section>
        </template>

        <!-- Detail view: show hospitalSystemInnerScreen when a HS ID is clicked -->
        <template if:true={showDetail}>
            <c-hospital-system-inner-screen health-system={selectedHS} onback={handleBack}></c-hospital-system-inner-screen>
        </template>

        <!-- Add Modal -->
        <template if:true={showAddModal}>
            <section role="dialog" aria-modal="true" class="hs-modal-backdrop">
                <div class="hs-modal">
                    <div class="hs-modal__header">
                        <div class="hs-modal__title">Add Health System</div>
                        <button class="hs-modal__close" title="Close" onclick={closeAddModal} aria-label="Close">✕</button>
                    </div>
                    <div class="hs-modal__body">
                        <div class="hs-modal__grid">
                            <div class="hs-form-group">
                                <label>HS Name</label>
                                <lightning-input name="formHsName" value={formHsName} onchange={handleInputChange} placeholder="Enter HS name"></lightning-input>
                            </div>
                             <div class="hs-form-group">
                                <label>Contact</label>
                                <lightning-input name="formContact" value={formContact} onchange={handleInputChange} placeholder="Enter contact"></lightning-input>
                            </div>
                            <div class="hs-form-group">
                                <label>State</label>
                                <div class="dropdown-container">
                                    <button class="dropdown-btn" onclick={toggleFormStateDropdown} type="button">
                                        <span>{formStateDisplay}</span>
                                        <span class="chevron">▼</span>
                                    </button>
                                    <div class={formStateDropdownClass}>
                                        <input type="text" class="dropdown-search" placeholder="Search State" oninput={handleFormStateSearchInput} />
                                        <ul class="dropdown-options">
                                            <template for:each={formFilteredStateOptions} for:item="opt">
                                                <li key={opt.value} data-value={opt.value} onclick={selectFormState}>
                                                    <label>{opt.label}</label>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="hs-form-group">
                                <label>City</label>
                                <div class="dropdown-container">
                                    <button class="dropdown-btn" onclick={toggleFormCityDropdown} type="button">
                                        <span>{formCityDisplay}</span>
                                        <span class="chevron">▼</span>
                                    </button>
                                    <div class={formCityDropdownClass}>
                                        <input type="text" class="dropdown-search" placeholder="Search City" oninput={handleFormCitySearchInput} />
                                        <ul class="dropdown-options">
                                            <template for:each={formFilteredCityOptions} for:item="opt">
                                                <li key={opt.value} data-value={opt.value} onclick={selectFormCity}>
                                                    <label>{opt.label}</label>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                           
                            <div class="hs-form-group">
                                <label>Email</label>
                                <lightning-input type="email" name="formEmail" value={formEmail} onchange={handleInputChange} placeholder="Enter email"></lightning-input>
                            </div>
                            <div class="hs-form-group">
                                <label>Phone</label>
                                <lightning-input type="tel" name="formPhone" value={formPhone} onchange={handleInputChange} placeholder="Enter phone"></lightning-input>
                            </div>
                        </div>
                    </div>
                    <div class="hs-modal__footer">
                        <button class="hs-btn-outline" onclick={closeAddModal}>Cancel</button>
                        <button class="hs-btn-primary" onclick={saveAdd}>Save</button>
                    </div>
                </div>
            </section>
        </template>

        <!-- Edit Modal -->
        <template if:true={showEditModal}>
            <section role="dialog" aria-modal="true" class="hs-modal-backdrop">
                <div class="hs-modal">
                    <div class="hs-modal__header">
                        <div class="hs-modal__title">Edit Health System</div>
                        <button class="hs-modal__close" title="Close" onclick={closeEditModal} aria-label="Close">✕</button>
                    </div>
                    <div class="hs-modal__body">
                        <div class="hs-modal__grid">
                            <div class="hs-form-group">
                                <label>HS Name</label>
                                <lightning-input name="formHsName" value={formHsName} onchange={handleInputChange} placeholder="Enter HS name"></lightning-input>
                            </div>
                            <div class="hs-form-group">
                                <label>Contact</label>
                                <lightning-input name="formContact" value={formContact} onchange={handleInputChange} placeholder="Enter contact"></lightning-input>
                            </div>
                            <div class="hs-form-group">
                                <label>Status</label>
                                <lightning-combobox name="formStatus" value={formStatus} options={statusOptionsList} placeholder="Select status" onchange={handleInputChange}></lightning-combobox>
                            </div>
                            <div class="hs-form-group">
                                <label>State</label>
                                <div class="dropdown-container">
                                    <button class="dropdown-btn" onclick={toggleFormStateDropdown} type="button">
                                        <span>{formStateDisplay}</span>
                                        <span class="chevron">▼</span>
                                    </button>
                                    <div class={formStateDropdownClass}>
                                        <input type="text" class="dropdown-search" placeholder="Search State" oninput={handleFormStateSearchInput} />
                                        <ul class="dropdown-options">
                                            <template for:each={formFilteredStateOptions} for:item="opt">
                                                <li key={opt.value} data-value={opt.value} onclick={selectFormState}>
                                                    <label>{opt.label}</label>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="hs-form-group">
                                <label>City</label>
                                <div class="dropdown-container">
                                    <button class="dropdown-btn" onclick={toggleFormCityDropdown} type="button">
                                        <span>{formCityDisplay}</span>
                                        <span class="chevron">▼</span>
                                    </button>
                                    <div class={formCityDropdownClass}>
                                        <input type="text" class="dropdown-search" placeholder="Search City" oninput={handleFormCitySearchInput} />
                                        <ul class="dropdown-options">
                                            <template for:each={formFilteredCityOptions} for:item="opt">
                                                <li key={opt.value} data-value={opt.value} onclick={selectFormCity}>
                                                    <label>{opt.label}</label>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="hs-form-group">
                                <label>Email</label>
                                <lightning-input type="email" name="formEmail" value={formEmail} onchange={handleInputChange} placeholder="Enter email"></lightning-input>
                            </div>
                            <div class="hs-form-group">
                                <label>Phone</label>
                                <lightning-input type="tel" name="formPhone" value={formPhone} onchange={handleInputChange} placeholder="Enter phone"></lightning-input>
                            </div>
                            
                        </div>
                    </div>
                    <div class="hs-modal__footer">
                        <button class="hs-btn-outline" onclick={closeEditModal}>Cancel</button>
                        <button class="hs-btn-primary" onclick={saveEdit}>Save</button>
                    </div>
                </div>
            </section>
        </template>
    </lightning-card>
</template>