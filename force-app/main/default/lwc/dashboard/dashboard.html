<template>
    <!-- Task/Todo header moved into the task card below for consistent layout -->

    <div class="kpi-grid-wrapper" style="    margin-left: -13px;">
        <div class="kpi-grid-layout">
            <!-- Physicians Card -->
            <div class="kpi-card-wrapper" style="cursor: pointer;">
            <div class="position-relative border card rounded-2 shadow-sm">
                <img src={bgImage01} alt="img" class="position-absolute start-0 top-0" />
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2 justify-content-between">
                        <span class="avatar bg-primary rounded-circle">
                            <lightning-icon icon-name="utility:user" alternative-text="Physicians" 
                                          class="fs-24" style="color: white;"></lightning-icon>
                        </span>
                        <div class="text-end">
                            <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-success">+95%</span>
                            <p class="fs-13 mb-0">in last 7 Days</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between no-tooltips">
                        <div>
                            <p class="fw-bold mb-1" style="font-size: 1rem;">Total Projects</p>
                            <h3 class="fw-bold mb-0" style="font-size: 1.5rem;">247</h3>
                        </div>
                        <div>
                                <div class="chart-set">
                                    <!-- KPI sparkline placeholder: ApexCharts will render here -->
                                    <div data-id="s-col" style="width:100%;height:54px;"></div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <!-- Patients Card -->
            <div class="kpi-card-wrapper" style="cursor: pointer;">
            <div class="position-relative border card rounded-2 shadow-sm">
                <img src={bgImage02} alt="img" class="position-absolute start-0 top-0" />
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2 justify-content-between">
                        <span class="avatar bg-danger rounded-circle">
                            <lightning-icon icon-name="utility:people" alternative-text="Patients" 
                                          class="fs-24" style="color: white;"></lightning-icon>
                        </span>
                        <div class="text-end">
                            <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-success">+25%</span>
                            <p class="fs-13 mb-0">in last 7 Days</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between no-tooltips">
                        <div>
                            <p class="fw-bold mb-1" style="font-size: 1rem;">Active Projects</p>
                            <h3 class="fw-bold mb-0" style="font-size: 1.5rem;">417</h3>
                        </div>
                        <div>
                            <div class="chart-set">
                                <!-- KPI sparkline placeholder: ApexCharts will render here -->
                                <div data-id="s-col-2" style="width:100%;height:54px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <!-- Task & Todo Grid occupying the right half of KPI rows -->
            <div class="task-grid-wrapper kpi-task-grid-cell" style="margin-top: 11px; height: 381px; margin-bottom: 12px;">
            <lightning-card title="Activities & Alerts"
                class="position-relative border card rounded-2 shadow-sm task-todo-card">
                <div slot="actions" class="task-grid-actions">
                        <button class="btn-sponsor-action" title="Add Todo" style="background-color: #ffff;
                            color: #2e37a4;
                            border: 1px solid #2e37a4;" onclick={openAddModal}>
                        <span class="plus-symbol">+</span>
                        <span class="action-label">To do</span>
                    </button>
                    <button class="btn-sponsor-action" title="Add Task" onclick={openAddActivityPopup}>
                        <span class="plus-symbol">+</span>
                        <span class="action-label">Task</span>
                    </button>
                    
                </div>
                <div class="card-body task-grid-body">
                    <div class="task-grid-table-wrapper">
                        <table class="task-grid-table slds-table slds-table_bordered slds-table_cell-buffer">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col">
                                        <div class="slds-truncate">Subject</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate">Due Date</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate">Project</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate">Responsibility</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={displayTaskTodoRecords} for:item="item">
                                    <tr key={item.id}>
                                        <td data-label="Subject">
                                            <div class="slds-truncate">
                                                <span class={item.subjectClass}>{item.subject}</span>
                                            </div>
                                        </td>
                                        <td data-label="Due Date">
                                            <div class="slds-truncate task-meta-text">{item.dueDate}</div>
                                        </td>
                                        <td data-label="Project">
                                            <div class="slds-truncate task-meta-text">{item.projectName}</div>
                                        </td>
                                        <td data-label="Responsibility">
                                            <div class="responsibility-cell">
                                                <span class="avatar thumb">
                                                    <template if:true={item.responsibilityPhoto}>
                                                        <img src={item.responsibilityPhoto} alt={item.responsibilityName}>
                                                    </template>
                                                    <template if:false={item.responsibilityPhoto}>
                                                        <span class="initials">{item.responsibilityInitials}</span>
                                                    </template>
                                                </span>
                                                <div>
                                                    <div class="responsibility-name">{item.responsibilityName}</div>
                                                    <div class="responsibility-org">{item.responsibilityOrg}</div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </lightning-card>
        </div>
            <!-- Appointments Card -->
            <div class="kpi-card-wrapper" style="cursor: pointer;">
            <div class="position-relative border card rounded-2 shadow-sm">
                <img src={bgImage03} alt="img" class="position-absolute start-0 top-0" />
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2 justify-content-between">
                        <span class="avatar bg-info rounded-circle">
                            <lightning-icon icon-name="utility:event" alternative-text="Appointments" 
                                          class="fs-24" style="color: white;"></lightning-icon>
                        </span>
                        <div class="text-end">
                            <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-danger">-15%</span>
                            <p class="fs-13 mb-0">in last 7 Days</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between no-tooltips">
                        <div>
                            <p class="fw-bold mb-1" style="font-size: 1rem;">Total Sponsors</p>
                            <h3 class="fw-bold mb-0" style="font-size: 1.5rem;">121</h3>
                        </div>
                        <div>
                            <div class="chart-set">
                                <!-- KPI sparkline placeholder: ApexCharts will render here -->
                                <div data-id="s-col-3" style="width:100%;height:54px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <!-- Revenue Card -->
            <div class="kpi-card-wrapper">
            <div class="position-relative border card rounded-2 shadow-sm">
                <img src={bgImage04} alt="img" class="position-absolute start-0 top-0" />
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2 justify-content-between">
                        <span class="avatar bg-success rounded-circle">
                            <lightning-icon icon-name="standard:account" alternative-text="Health Systems" 
                                          class="fs-24" style="color: white;"></lightning-icon>
                        </span>
                        <div class="text-end">
                            <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-success">+25%</span>
                            <p class="fs-13 mb-0">in last 7 Days</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between overflow-hidden no-tooltips">
                        <div>
                            <p class="fw-bold mb-1" style="font-size: 1rem;">Total Health Systems</p>
                            <h3 class="fw-bold mb-0 text-truncate" style="font-size: 1.5rem;">556</h3>
                        </div>
                        <div>
                            <div class="chart-set">
                                <!-- KPI sparkline placeholder: ApexCharts will render here -->
                                <div data-id="s-col-4" style="width:100%;height:54px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Full width column chart placed after KPI cards -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title fw-bold mb-0" style="font-size: 1.5em !important;">Monthly Project Trend</h5>
                    <div class="float-end">
                        <select class="year-select" onchange={handleYearChange} value={selectedYear}>
                            <template for:each={years} for:item="yr">
                                <option key={yr} value={yr}>{yr}</option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart column-chart-container">
                        <!-- ApexCharts will render into this div -->
                        <div data-id="apexChart" style="width:100%;height:100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row below the column chart divided into three equal columns -->
    <div class="row three-column-row">
        <!-- Left: Status pie (Highcharts) -->
    <div class="col-xl-4 col-lg-4 d-flex">
            <div class="card shadow-sm flex-fill w-100 h-100 d-flex flex-column">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h3 class="fw-bold mb-0 text-color" style="font-size: 1.5em !important;">Projects By Type</h3>
                    <div class="float-end">
                        <select class="year-select" onchange={handleYearChange} value={selectedYear} style="width: 81px;">
                            <template for:each={years} for:item="yr">
                                <option key={yr} value={yr}>{yr}</option>
                            </template>
                        </select>
                    </div>
                </div>

                <div class="card-body flex-fill">
                    <div class="col-sm-12">
                        <figure class="highcharts-figure mb-0">
                            <!-- reduced height so pie doesn't dominate the row -->
                            <div id="container10" data-id="container10" style="width: 100%; height: 320px; min-height: 260px;"></div>
                        </figure>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle: Bottom 5 CVP's card -->
    <div class="col-xl-4 col-lg-4 d-flex">
            <div class="card shadow-sm flex-fill w-100 h-100 d-flex flex-column">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="fw-bold mb-0 text-color" style="font-size: 1.5em !important;">Top 5 Specialities in Projects</h5>
                    <div class="float-end">
                        <select class="year-select" onchange={handleYearChange} value={selectedYear} style="width: 81px;">
                            <template for:each={years} for:item="yr">
                                <option key={yr} value={yr}>{yr}</option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="card-body flex-fill">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <a class="avatar me-2 flex-shrink-0">
                                <img src={av1} alt="img" class="rounded-circle">
                            </a>
                            <div>
                                <h6 class="fs-14 mb-1 text-truncate"><a class="fw-medium">Cardiology</a></h6>
                                <p class="mb-0 fs-13 text-truncate">Total Studies : 200</p>
                            </div>
                        </div>
                        <span class="badge fw-medium bg-success flex-shrink-0">90</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <a class="avatar me-2 flex-shrink-0">
                                <img src={av2} alt="img" class="rounded-circle">
                            </a>
                            <div>
                                <h6 class="fs-14 mb-1 text-truncate"><a class="fw-medium">Neurology</a></h6>
                                <p class="mb-0 fs-13 text-truncate">Total Studies : 150</p>
                            </div>
                        </div>
                        <span class="badge fw-medium bg-success flex-shrink-0">90</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <a  class="avatar me-2 flex-shrink-0">
                                <img src={av3} alt="img" class="rounded-circle">
                            </a>
                            <div>
                                <h6 class="fs-14 mb-1 text-truncate"><a class="fw-medium">Oncology</a></h6>
                                <p class="mb-0 fs-13 text-truncate">Total Studies : 121</p>
                            </div>
                        </div>
                        <span class="badge fw-medium bg-success flex-shrink-0">90</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <a class="avatar me-2 flex-shrink-0">
                                <img src={av4} alt="img" class="rounded-circle">
                            </a>
                            <div>
                                <h6 class="fs-14 mb-1 text-truncate"><a class="fw-medium">Orthopedics</a></h6>
                                <p class="mb-0 fs-13 text-truncate">Total Studies : 100</p>
                            </div>
                        </div>
                        <span class="badge fw-medium bg-success flex-shrink-0">90</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-0">
                        <div class="d-flex align-items-center">
                            <a class="avatar me-2 flex-shrink-0">
                                <img src={av5} alt="img" class="rounded-circle">
                            </a>
                            <div>
                                <h6 class="fs-14 mb-1 text-truncate"><a class="fw-medium">Anesthesiology</a></h6>
                                <p class="mb-0 fs-13 text-truncate">Total Studies : 50</p>
                            </div>
                        </div>
                        <span class="badge fw-medium bg-success flex-shrink-0">90</span>
                    </div>
                </div>
            </div>
        </div>

    <!-- Right: Top 3 CVP's donut chart -->
    <div class="col-xl-4 col-lg-4 d-flex donut-column">
            <div class="card shadow-sm flex-fill w-100 h-100 d-flex flex-column">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="fw-bold mb-0 text-color" style="font-size: 1.5em !important;">Projects By Trial Status</h5>
                    <div class="float-end">
                        <select class="year-select" onchange={handleYearChange} value={selectedYear} style="width: 81px;">
                            <template for:each={years} for:item="yr">
                                <option key={yr} value={yr}>{yr}</option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="card-body flex-fill">
                    <div class="col-sm-12">
                        <figure class="highcharts-figure mb-0">
                            <!-- Apex donut will render into this container; size controlled by CSS for responsiveness -->
                            <div data-id="apexDonut" style="width:100%;height:320px;min-height:260px;max-width:380px;margin:0 auto;"></div>
                                <!-- overlay element for center total (kept as separate DOM so it's always visible) -->
                                <div data-id="donutCenter" class="donut-center" aria-hidden="false"></div>
                        </figure>
                    </div>
                    <!-- custom legend placed inside the card so it remains within the white background -->
                    <div data-id="donutLegend" class="donut-legend" aria-hidden="false"></div>
                </div>
            </div>
        </div>
    </div>

        <!-- Full-width heatmap row placed after the three-column row -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm flex-fill w-100">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="fw-bold mb-0 text-color" style="font-size: 1.5em !important;">Project Tasks Volume Heatmap</h5>
                    <div class="float-end">
                        <select class="year-select" onchange={handleYearChange} value={selectedYear} style="width: 81px;">
                            <template for:each={years} for:item="yr">
                                <option key={yr} value={yr}>{yr}</option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <!-- custom legend for heatmap placed inside the card so it remains within the white background -->
                    <div data-id="heatmapLegend" class="heatmap-legend" aria-hidden="false"></div>
                    <div class="col-sm-12">
                        <div data-id="apexHeatmap" style="width:100%;height:360px;min-height:320px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template if:true={showAddModal}>
        <section role="dialog" aria-modal="true" class="modal-backdrop">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">Add To Do</div>
                    <button class="modal-close" title="Close" onclick={closeAddModal} aria-label="Close">âœ•</button>
                </div>
                <div class="modal-body">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>Subject</label>
                            <lightning-input name="formSubject" value={formSubject} onchange={handleInputChange} placeholder="Enter subject"></lightning-input>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <lightning-input type="date" name="formDueDate" value={formDueDate} onchange={handleInputChange}></lightning-input>
                        </div>
                        <div class="form-group">
                            <label>Due Time</label>
                            <lightning-input type="time" name="formDueTime" value={formDueTime} onchange={handleInputChange}></lightning-input>
                        </div>
                        <div class="form-group">
                            <label>Project Name</label>
                            <lightning-input name="formProjectName" value={formProjectName} onchange={handleInputChange} placeholder="Enter project"></lightning-input>
                        </div>
                        <div class="form-group">
                            <label>Responsibility</label>
                            <lightning-input name="formResponsibility" value={formResponsibility} onchange={handleInputChange} placeholder="Enter owner"></lightning-input>
                        </div>
                        <div class="form-group">
                            <label>HS Name</label>
                            <lightning-combobox name="formHsName" value={formHsName} options={hsOptions} placeholder="Select HS" onchange={handleInputChange}></lightning-combobox>
                        </div>
                        <div class="form-group">
                            <label>Sponsor Name</label>
                            <lightning-combobox name="formSponsorName" value={formSponsorName} options={sponsorOptions} placeholder="Select Sponsor" onchange={handleInputChange}></lightning-combobox>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-outline" onclick={closeAddModal}>Cancel</button>
                    <button class="btn-primary" onclick={saveTodo}>Save</button>
                </div>
            </div>
        </section>
    </template>

    <template if:true={isAddActivityOpen}>
        <div class="modal-overlay" onclick={handleModalOverlayClick}>
            <div class="modal-card" role="dialog" onclick={stopPropagation}>
                <div class="modal-header">
                    <h3>Add Task</h3>
                </div>
                <div class="modal-body">
                    <div style="display:flex; gap:1rem; align-items:flex-start;">
                        <div style="flex:1; min-width:0;">
                            <div class="form-row">
                                <label>Milestone</label>
                                <lightning-combobox options={milestoneOptions} value={addFormMilestone}
                                    onchange={handleAddFormMilestoneChange}></lightning-combobox>
                            </div>
                            <div class="form-row">
                                <label>Task Description</label>
                                <textarea placeholder="Enter task description"
                                    value={addFormDescription}
                                    onchange={handleAddFormDescriptionChange}
                                    style="height:246px; min-height:246px; width:100%; box-sizing:border-box; padding:0.5rem; border-radius: 4px;">
                                </textarea>
                            </div>
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div class="form-row">
                                <label>Plan Start</label>
                                <lightning-input type="date" value={addFormPlanStart} onchange={handleAddFormPlanStartChange}></lightning-input>
                            </div>
                            <div class="form-row">
                                <label>Plan Finish</label>
                                <lightning-input type="date" value={addFormPlanFinish} onchange={handleAddFormPlanFinishChange}></lightning-input>
                            </div>
                            <div class="form-row">
                                <label>Actual Start</label>
                                <lightning-input type="date" value={addFormActualStart} onchange={handleAddFormActualStartChange}></lightning-input>
                            </div>
                            <div class="form-row">
                                <label>ETA</label>
                                <lightning-input type="date" value={addFormEta} onchange={handleAddFormEtaChange}></lightning-input>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" onclick={closeAddActivityPopup}>Close</button>
                    <button class="btn btn-primary" onclick={saveAddActivity}>Save</button>
                </div>
            </div>
        </div>
    </template>

</template>


